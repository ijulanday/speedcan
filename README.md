# speedcan

A library for use with Currawong Velocity ESC and their Velocity SDK to be ran on Teensy 4.x

## example program
```c
#include "speedcan.h"
#include <Metro.h>

FlexCAN_T4<CAN1, RX_SIZE_256, TX_SIZE_16> can1;


Metro statusUpdate = Metro(2000);
Metro blink = Metro(1000);

char led_status = 0;

//------------------------------------------------------------------------------
void setup()
{
  Serial.begin(9600);
  while (!Serial) {}
  can1.begin();
  can1.setBaudRate(1000000);
  pinMode(LED_BUILTIN, OUTPUT);
  digitalWrite(LED_BUILTIN, HIGH);
}
 
void loop()
{
  if (can1.read(esc_message))
    incomingMessageHandler();
  if (blink.check()) {
    led_status ^= 0x1;
    digitalWrite(LED_BUILTIN, led_status);
    if (led_status)
      broadcastPWMcommand(1000, &can1);
    else
      broadcastPWMcommand(1500, &can1);
  }

  if (statusUpdate.check())
    printStatus();
}
```

## protocol notes

Here are some notes pertaining to the ESC CAN protocol and SDK. For more detailed information, please refer to the manufacturer's documentation. **Note**: the ESC CAN protocol represents its data in **Big Endian**.

#### The ID field

Velocity ESCs use an extended 29-bit ID field, in which contains the ID header, command code, device type, and device address.
*   The first five bits are always 0x7 to indicate a packet for a Velocity ESC
*   The next byte is the code for command / packet type identification
*   The next byte is the device type, 0x20 for ESC 
*   The last byte is the device address, **or 0xFF if broadcasting to all devices on the bus**.

#### Configuration changes

The workflow of changing ESC configuration settings is to unlock the device config via command, issue config change commands, then lock the device configuration so that changes will be saved after reset.  
  
The recommended way of making configuration changes is via the cEQUIP software, which is available from Currawong after purchase of their ESCs.

#### Velocity SDK

The Velocity SDK implements easy ways of creating CAN packets for the ESC CAN protocol. This SDK consists of C++ files generated by ProtoGen (now Google's ProtoBuf?) along with some code from Currawong that defines a packet class and implements functions for generating these packets. This SDK is not available as open source and must be obtained from Currawong Engineering.

This library uses these SDK functions and does not work as a standalone unit, although with sufficient knowledge of the protocol modifications can be made to make the code here standalone. The typical workflow is to pass a packet object to a decode/encode function from the SDK as a pointer, move the packet's contents to another packet object of your choice, then transmit that over the CAN bus via a compatible library (in this case, the FlexCAN_T4 library).

## dependancies
*   velocity_sdk_v3 (not on GitHub, contact Currawong or regional distributor)
*   [FlexCAN_T4](https://github.com/tonton81/FlexCAN_T4/)
*   Arduino